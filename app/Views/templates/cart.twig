{# app/Views/templates/cart.twig #}
{% extends "base.twig" %}

{% block title %}Nákupní košík - Délicious{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="fw-bold mb-4" style="color: #0f172a;">
            <i class="bi bi-cart-fill" style="color: #f97316;"></i> Nákupní košík
        </h2>

        {# Alert box pro zprávy #}
        <div id="alertBox" class="alert d-none" role="alert">
            <span id="alertMessage"></span>
        </div>
    </div>
</div>

{% if cartItems|length > 0 %}
<div class="row">
    <div class="col-lg-8">
        {# Cart items #}
        {% for item in cartItems %}
        <div class="card card-modern mb-3" id="cart-item-{{ item.product_id }}">
            <div class="card-body">
                <div class="row align-items-center">
                    {# Product Image #}
                    <div class="col-3 col-md-2 mb-2 mb-md-0">
                        {% if item.image %}
                            <img src="uploads/{{ item.image }}" alt="{{ item.name }}" class="img-fluid" style="border-radius: 8px; max-height: 80px; object-fit: cover;">
                        {% else %}
                            <div class="text-center" style="height: 80px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 8px;">
                                <i class="bi bi-image" style="font-size: 2rem; color: #cbd5e1;"></i>
                            </div>
                        {% endif %}
                    </div>

                    {# Product Details #}
                    <div class="col-7 col-md-4 mb-2 mb-md-0">
                        <h5 class="fw-bold mb-1" style="color: #0f172a; font-size: 1rem;">{{ item.name }}</h5>
                        <p class="text-muted mb-0" style="font-size: 0.85rem;">
                            <i class="bi bi-shop" style="color: #f97316;"></i> {{ item.supplier_name }}
                        </p>
                        <small class="text-muted d-md-none">{{ item.price }} Kč/ks</small>
                    </div>

                    {# Remove Button Mobile #}
                    <div class="col-2 d-md-none text-end">
                        <button class="btn btn-link text-danger p-0" onclick="removeFromCart({{ item.product_id }})" title="Odebrat">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>

                    {# Quantity Controls #}
                    <div class="col-8 col-md-3 mb-2 mb-md-0">
                        <small class="text-muted d-md-none d-block mb-1">Množství:</small>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity({{ item.product_id }}, -1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="form-control text-center" id="quantity-{{ item.product_id }}" value="{{ item.quantity }}" min="1" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity({{ item.product_id }}, 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    {# Price #}
                    <div class="col-4 col-md-2 text-end mb-2 mb-md-0">
                        <p class="fw-bold mb-0" style="color: #0f172a; font-size: 1.1rem;">
                            <span id="subtotal-{{ item.product_id }}">{{ item.subtotal }}</span> Kč
                        </p>
                        <small class="text-muted d-none d-md-block">{{ item.price }} Kč/ks</small>
                    </div>

                    {# Remove Button Desktop #}
                    <div class="col-md-1 text-end d-none d-md-block">
                        <button class="btn btn-link text-danger" onclick="removeFromCart({{ item.product_id }})" title="Odebrat">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {# Clear Cart Button #}
        <button class="btn btn-modern btn-modern-secondary mb-4" onclick="clearCart()">
            <i class="bi bi-trash-fill"></i> Vyprázdnit košík
        </button>
    </div>

    {# Order Summary #}
    <div class="col-lg-4">
        <div class="card card-modern">
            <div class="card-body">
                <h5 class="fw-bold mb-4" style="color: #0f172a;">Souhrn objednávky</h5>

                <div class="d-flex justify-content-between mb-2">
                    <span>Mezisoučet:</span>
                    <span id="cartTotal">{{ total }}</span> Kč
                </div>

                <div class="d-flex justify-content-between mb-3">
                    <span>Doprava:</span>
                    <span class="text-success">Zdarma</span>
                </div>

                <hr>

                <div class="d-flex justify-content-between mb-4">
                    <strong style="font-size: 1.2rem;">Celkem:</strong>
                    <strong style="font-size: 1.2rem; color: #f97316;" id="finalTotal">{{ total }}</strong> Kč
                </div>

                <a href="?page=checkout" class="btn btn-modern btn-modern-primary w-100 py-3 mb-2">
                    <i class="bi bi-credit-card-fill me-2"></i> Pokračovat k objednávce
                </a>

                <a href="?page=products" class="btn btn-modern btn-modern-secondary w-100">
                    <i class="bi bi-arrow-left me-2"></i> Pokračovat v nákupu
                </a>
            </div>
        </div>
    </div>
</div>

{% else %}
{# Empty Cart #}
<div class="row">
    <div class="col-12">
        <div class="card card-modern text-center p-5">
            <i class="bi bi-cart-x" style="font-size: 5rem; color: #cbd5e1;"></i>
            <h4 class="mt-4" style="color: #64748b;">Váš košík je prázdný</h4>
            <p style="color: #94a3b8;">Přidejte produkty z naší nabídky</p>
            <a href="?page=products" class="btn btn-modern btn-modern-primary mt-3">
                <i class="bi bi-basket-fill me-2"></i> Zobrazit produkty
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Update quantity
function updateQuantity(productId, change) {
    const quantityInput = document.getElementById('quantity-' + productId);
    let newQuantity = parseInt(quantityInput.value) + change;

    if (newQuantity < 1) {
        return;
    }

    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('quantity', newQuantity);

    fetch('?page=cart&action=update', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            quantityInput.value = newQuantity;

            // Update subtotal for this item
            const price = parseFloat(document.querySelector(`#cart-item-${productId} small.text-muted`).textContent);
            const subtotal = price * newQuantity;
            document.getElementById('subtotal-' + productId).textContent = subtotal.toFixed(2);

            // Update total
            document.getElementById('cartTotal').textContent = data.total.toFixed(2);
            document.getElementById('finalTotal').textContent = data.total.toFixed(2);

            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Chyba:', error);
        showNotification('Chyba při aktualizaci množství', 'error');
    });
}

// Remove from cart
function removeFromCart(productId) {
    if (!confirm('Opravdu chcete odebrat tento produkt z košíku?')) {
        return;
    }

    const formData = new FormData();
    formData.append('product_id', productId);

    fetch('?page=cart&action=remove', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove item from DOM
            document.getElementById('cart-item-' + productId).remove();

            showNotification(data.message, 'success');

            // Reload if cart is empty
            if (data.cartCount === 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Chyba:', error);
        showNotification('Chyba při odebírání produktu', 'error');
    });
}

// Clear entire cart
function clearCart() {
    if (!confirm('Opravdu chcete vyprázdnit celý košík?')) {
        return;
    }

    fetch('?page=cart&action=clear', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Chyba:', error);
        showNotification('Chyba při mazání košíku', 'error');
    });
}

// Show notification
function showNotification(message, type) {
    const alertBox = document.getElementById('alertBox');
    const alertMessage = document.getElementById('alertMessage');

    alertBox.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
    alertMessage.textContent = message;
    alertBox.classList.remove('d-none');

    setTimeout(() => {
        alertBox.classList.add('d-none');
    }, 3000);
}
</script>
{% endblock %}
